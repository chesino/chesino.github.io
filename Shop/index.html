<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa hàng Digital - Phiên bản mới</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            /* Prevent scrollbar flickering */
            overflow-y: scroll;
        }

        /* Show the active checkout step */
        #checkout-view>div {
            display: none;
        }

        /* Show only the active step */
        #checkout-view>div.active {
            display: block;
        }


        .view-section {
            display: none;
            /* Hide all main view sections by default */
        }

        .view-section.active {
            display: block;
            /* Show active view section */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Add padding to the bottom of the main content on mobile to avoid being hidden by fixed bar */
        @media (max-width: 767px) {

            /* Tailwind's 'md' breakpoint is 768px */
            #product-list-view {
                padding-bottom: 80px;
                /* Adjust based on the height of your mobile filter bar */
            }
        }

        @media (min-width: 768px) {
            #mobile-nav {
                display: none;
            }
        }

        /* Custom style for radio button checkmark */
        input[type="radio"]:checked+label::before {
            content: '\f058';
            /* Font Awesome check-circle icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: #10b981;
            /* emerald-500 */
            margin-right: 0.5rem;
        }

        input[type="radio"]+label::before {
            content: '\f111';
            /* Font Awesome circle icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 400;
            /* Regular weight */
            color: #d1d5db;
            /* gray-300 */
            margin-right: 0.5rem;
        }

        input[type="radio"] {
            display: none;
            /* Hide the default radio button */
        }

        input[type="radio"]+label {
            cursor: pointer;
            display: flex;
            /* Use flex to align icon and text */
            align-items: center;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans min-h-screen flex flex-col">

    <header class="bg-white text-gray-800 p-4 shadow-md sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-600">Digital Shop</h1>
            <nav class="hidden md:block">
                <ul class="flex space-x-6">
                    <li><button
                            class="nav-link text-gray-700 hover:text-blue-600 transition-colors duration-200 font-medium"
                            data-view="product-list-view">Sản phẩm</button></li>
                    <li>
                        <button
                            class="nav-link text-gray-700 hover:text-blue-600 transition-colors duration-200 font-medium"
                            data-view="order-status-view">
                            Kiểm tra đơn hàng
                        </button>
                    </li>

                </ul>
            </nav>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button id="cart-icon"
                        class="text-gray-700 text-2xl focus:outline-none p-1 rounded-full hover:bg-gray-200 transition-colors duration-200">
                        <i class="fas fa-shopping-bag"></i> <span id="cart-count"
                            class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center -mt-1 -mr-2 border-2 border-white">0</span>
                    </button>
                    <div id="cart-dropdown"
                        class="hidden absolute right-0 mt-3 w-64 bg-white rounded-lg shadow-xl py-3 z-10 origin-top-right transform scale-95 opacity-0 transition-all duration-200 ease-out">
                        <div class="px-4 py-2 border-b border-gray-200">
                            <h4 class="text-lg font-semibold text-gray-800">Giỏ hàng</h4>
                        </div>
                        <div id="cart-items-dropdown" class="px-4 py-2 text-gray-800 max-h-60 overflow-y-auto">Giỏ hàng
                            trống</div>
                        <div class="border-t border-gray-200 mt-2 pt-3 px-4">
                            <p class="font-bold text-gray-800 text-lg">Tổng cộng: <span id="cart-total-dropdown"
                                    class="text-blue-600">0đ</span></p>
                            <button id="go-to-checkout-btn-dropdown"
                                class="mt-3 w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">Tiến
                                hành thanh toán</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-4 gap-6 flex-grow">

        <aside id="sidebar" class="md:col-span-1 bg-white p-6 rounded-lg shadow-xl h-fit hidden md:block">
            <h2 class="text-xl font-bold mb-6 text-gray-800">Bộ lọc & Sắp xếp</h2>

            <div class="mb-6">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">Tìm kiếm sản phẩm</label>
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Nhập tên sản phẩm..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <div class="mb-6">
                <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-2">Danh mục</label>
                <select id="category-filter"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white appearance-none">
                    <option value="all">Tất cả</option>
                </select>
            </div>

            <div class="mb-6">
                <label for="sort-select" class="block text-sm font-medium text-gray-700 mb-2">Sắp xếp theo</label>
                <select id="sort-select"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white appearance-none">
                    <option value="default">Mặc định</option>
                    <option value="name-asc">Tên (A-Z)</option>
                    <option value="name-desc">Tên (Z-A)</option>
                    <option value="price-asc">Giá (Thấp đến cao)</option>
                    <option value="price-desc">Giá (Cao đến thấp)</option>
                </select>
            </div>
        </aside>

        <section id="main-content-area" class="md:col-span-3">

            <div id="product-list-view" class="view-section active">
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
                <div id="no-products-message" class="hidden text-center text-gray-500 mt-8 text-lg">Không tìm thấy sản
                    phẩm nào phù hợp.</div>
            </div>
            <div id="order-status-view" class="view-section bg-white p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Kiểm tra đơn hàng</h2>

                <div class="max-w-md mx-auto">
                    <label for="order-code-input" class="block text-sm font-medium text-gray-700 mb-2">Nhập mã đơn
                        hàng</label>
                    <input type="text" id="order-code-input"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">

                    <button id="check-order-btn"
                        class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200">
                        Kiểm tra
                    </button>

                    <div id="order-result"
                        class="mt-6 hidden bg-gray-50 border border-gray-200 p-4 rounded-md text-sm text-gray-700">
                        <!-- Kết quả đơn hàng sẽ hiển thị ở đây -->
                    </div>
                </div>
            </div>



            <div id="checkout-view" class="view-section bg-white p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Thanh toán</h2>

                <div class="flex justify-between items-center mb-6 text-sm font-semibold text-gray-600">
                    <div class="flex-1 text-center border-b-2 pb-2 border-blue-600 text-blue-600">1. Giỏ hàng</div>
                    <div class="flex-1 text-center border-b-2 pb-2 border-gray-300">2. Thông tin</div>
                    <div class="flex-1 text-center border-b-2 pb-2 border-gray-300">3. Thanh toán</div>
                    <div class="flex-1 text-center border-b-2 pb-2 border-gray-300">4. Hoàn tất</div>
                </div>


                <div id="checkout-step-1" class="checkout-step active">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Bước 1: Giỏ hàng & Mã ưu đãi</h3>
                    <div id="cart-items-list">
                    </div>
                    <div id="cart-empty-message" class="text-center text-gray-500 text-lg py-8">
                        <i class="fas fa-shopping-bag text-6xl mb-4"></i>
                        <p>Giỏ hàng của bạn đang trống.</p>
                        <button id="go-shopping-from-cart"
                            class="mt-4 bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">Tiếp
                            tục mua sắm</button>
                    </div>

                    <h4 class="text-lg font-semibold mb-3 text-gray-800 mt-8">Mã ưu đãi (Mô phỏng)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="discount-code" class="block text-sm font-medium text-gray-700 mb-2">Mã giảm
                                giá</label>
                            <input type="text" id="discount-code"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                placeholder="Nhập mã giảm giá">
                        </div>
                        <div>
                            <label for="referral-code" class="block text-sm font-medium text-gray-700 mb-2">Mã giới
                                thiệu</label>
                            <input type="text" id="referral-code"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                placeholder="Nhập mã giới thiệu">
                        </div>
                    </div>
                    <div class="text-right mb-6">
                        <button id="apply-codes-btn"
                            class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200">Áp
                            dụng mã</button>
                    </div>
                    <div id="discount-message" class="text-green-600 text-sm mt-2 hidden"></div>
                    <div id="referral-message" class="text-green-600 text-sm mt-1 hidden"></div>


                    <div id="cart-summary-area">
                        <div
                            class="border-t border-gray-200 mt-6 pt-6 flex flex-col md:flex-row justify-between items-center">
                            <p class="text-xl font-bold mb-4 md:mb-0">Tổng cộng:</p>
                            <p class="text-xl font-bold text-blue-600"><span id="cart-total">0đ</span></p>
                        </div>
                        <div class="mt-6 text-right space-y-4 md:space-y-0 md:space-x-4">
                            <button id="continue-shopping-btn"
                                class="bg-gray-300 text-gray-800 py-3 px-6 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200 w-full md:w-auto">Tiếp
                                tục mua sắm</button>
                            <button id="next-step-2-btn"
                                class="bg-blue-600 text-white py-3 px-6 rounded-md text-lg font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto"
                                disabled>Tiếp tục</button>
                        </div>
                    </div>
                </div>

                <div id="checkout-step-2" class="checkout-step">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Bước 2: Thông tin người nhận</h3>

                    <div class="grid grid-cols-1 gap-6 mb-6">
                        <div>
                            <label for="recipient-name" class="block text-sm font-medium text-gray-700 mb-2">Tên người
                                nhận</label>
                            <input type="text" id="recipient-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                        <div>
                            <label for="recipient-email"
                                class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="recipient-email"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        </div>
                        <div>
                            <label for="order-notes" class="block text-sm font-medium text-gray-700 mb-2">Nội dung / Ghi
                                chú đơn hàng</label>
                            <textarea id="order-notes" rows="4"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                placeholder="Nhập nội dung hoặc ghi chú cho đơn hàng"></textarea>
                        </div>
                    </div>

                    <div class="text-right space-x-4">
                        <button id="prev-step-1-btn"
                            class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200">Quay
                            lại</button>
                        <button id="next-step-3-btn"
                            class="bg-blue-600 text-white py-2 px-6 rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">Tiếp
                            tục</button>
                    </div>
                </div>

                <div id="checkout-step-3" class="checkout-step">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Bước 3: Thanh toán</h3>

                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Chọn phương thức thanh toán</h4>
                    <div class="mb-6 space-y-4">
                        <div class="flex items-center bg-gray-50 p-4 rounded-md border border-gray-200">
                            <input type="radio" id="payment-qr" name="payment-method" value="qr"
                                class="focus:ring-blue-500 h-5 w-5 text-blue-600 border-gray-300 cursor-pointer"
                                checked>
                            <label for="payment-qr"
                                class="ml-3 block text-base font-medium text-gray-700 cursor-pointer">Chuyển khoản Ngân
                                hàng (Scan QR Code)</label>
                        </div>
                        <div class="flex items-center bg-gray-50 p-4 rounded-md border border-gray-200">
                            <input type="radio" id="payment-momo" name="payment-method" value="momo"
                                class="focus:ring-blue-500 h-5 w-5 text-blue-600 border-gray-300 cursor-pointer">
                            <label for="payment-momo"
                                class="ml-3 block text-base font-medium text-gray-700 cursor-pointer">Ví điện tử Momo
                                (Scan QR Code)</label>
                        </div>
                    </div>

                    <div class="text-right space-x-4">
                        <button id="prev-step-2-btn"
                            class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200">Quay
                            lại</button>
                        <button id="complete-order-btn"
                            class="bg-green-500 text-white py-2 px-6 rounded-md font-semibold hover:bg-green-600 transition-colors duration-200 shadow-md">Hoàn
                            tất</button>
                    </div>
                </div>

                <div id="checkout-step-4" class="checkout-step">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Bước 4: Hoàn tất & Hướng dẫn thanh toán</h3>
                    <div class="text-center mb-6 p-6 bg-green-50 rounded-lg border border-green-200">
                        <i class="fas fa-check-circle text-green-600 text-6xl mb-4"></i>
                        <p class="text-2xl font-bold text-green-800 mb-2">Đơn hàng của bạn đã được đặt thành công!</p>
                        <p class="text-lg text-gray-700">Mã đơn hàng của bạn là: <span id="order-id"
                                class="font-bold text-blue-600">#...</span></p>
                        <p class="text-sm text-gray-600 mt-2">(Lưu ý: Đây là trang demo, đơn hàng không được lưu trữ
                            hoặc xử lý thực tế)</p>
                    </div>

                    <div id="payment-instructions"
                        class="mb-6 border border-gray-200 rounded-lg p-6 bg-white shadow-sm">
                        <h4 class="text-lg font-semibold mb-4 text-gray-800">Thông tin thanh toán (Mô phỏng)</h4>
                        <div id="qr-code-area" class="text-center">
                            <img id="payment-qr-img" src="" alt="Mã QR Thanh toán"
                                class="mx-auto mb-4 w-48 h-48 object-contain border border-gray-300 rounded-md p-2 bg-white">
                            <p id="payment-account-info" class="text-gray-700 text-sm leading-relaxed"></p>
                            <p class="text-red-600 font-semibold mt-3 text-sm">Vui lòng ghi rõ mã đơn hàng (<span
                                    class="font-bold" id="order-id-in-instruction">#...</span>) trong nội dung chuyển
                                khoản.</p>
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <p class="text-gray-700 mb-6 text-base">Trong một website thật, thông tin sản phẩm sẽ được gửi
                            qua Email sau khi thanh toán thành công.</p>
                        <button id="back-to-home-btn-checkout"
                            class="bg-blue-600 text-white py-3 px-8 rounded-md text-lg font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-md">Quay
                            lại trang chủ</button>
                    </div>
                </div>


            </div>


        </section>

    </main>

    <div id="mobile-filter-bar"
        class="fixed bottom-[65px] m-[10px] rounded-[10px] left-0 right-0 bg-white p-[8px] shadow-lg z-10 flex items-center justify-between space-x-2 overflow-x-auto md:hidden">
        <div class="flex-[2] min-w-0">
            <div class="relative">
                <input type="text" id="search-input-mobile" placeholder="Tìm kiếm..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 text-sm">
                <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
            </div>
        </div>

        <div class="flex-1 min-w-0">
            <select id="category-filter-mobile"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white appearance-none text-sm">
                <option value="all">Danh mục</option>
            </select>
        </div>

        <div class="flex-1 min-w-0">
            <select id="sort-select-mobile"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 bg-white appearance-none text-sm">
                <option value="default">Sắp xếp</option>
                <option value="name-asc">Tên (A-Z)</option>
                <option value="name-desc">Tên (Z-A)</option>
                <option value="price-asc">Giá (Thấp)</option>
                <option value="price-desc">Giá (Cao)</option>
            </select>
        </div>
    </div>
    <nav id="mobile-nav"
        class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-30 flex justify-around items-center p-2 md:hidden">
        <button class="mobile-nav-link flex flex-col items-center text-gray-600 hover:text-blue-600 text-sm"
            data-view="product-list-view">
            <i class="fas fa-box text-lg mb-1"></i>
            Sản phẩm
        </button>
        <button class="mobile-nav-link flex flex-col items-center text-gray-600 hover:text-blue-600 text-sm"
            data-view="order-status-view">
            <i class="fas fa-search text-lg mb-1"></i>
            Đơn hàng
        </button>
    </nav>



    <div id="message-box"
        class="hidden fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-md shadow-lg z-50 transition-opacity duration-300 ease-in-out opacity-0 max-w-xs">
        <p id="message-box-text"></p>
    </div>

    <footer class="bg-gray-800 text-white mt-8 py-6 text-center">
        <div class="container mx-auto">
            <p>&copy; 2023 Digital Shop Demo. All rights reserved.</p>
        </div>
    </footer>


    <script>
        // --- Product Data (Hardcoded) ---
        const products = [
            {
                "id": 1,
                "name": "4English chính chủ",
                "duration": "1 năm",
                "priceDisplay": "560k",
                "priceNumeric": 560000,
                "warranty": "FULL-TIME",
                "notes": "GỬI TÀI KHOẢN+ PASS TÀI KHOẢN",
                "category": "Học tập",
                "imageUrl": "https://placehold.co/150x150/E2E8F0/000000?text=4English" // Placeholder image
            },
            {
                "id": 2,
                "name": "AdGuard Premium Lifetime Key",
                "duration": "Vĩnh viễn",
                "priceDisplay": "180k",
                "priceNumeric": 180000,
                "warranty": "3 tháng",
                "notes": "Hỗ trợ 1 thiết bị",
                "category": "Phần mềm bảo mật",
                "imageUrl": "https://placehold.co/150x150/E2E8F0/000000?text=AdGuard" // Placeholder image
            },
            {
                "id": 3,
                "name": "Adobe Creative Cloud 3D substance app",
                "duration": "12 tháng",
                "priceDisplay": "780k",
                "priceNumeric": 780000,
                "warranty": "FULL-TIME",
                "notes": "Gửi mỗi mail là được anh em",
                "category": "Phần mềm sáng tạo",
                "imageUrl": "https://placehold.co/150x150/E2E8F0/000000?text=Adobe+3D" // Placeholder image
            },
            {
                "id": 4,
                "name": "Adobe Creative Cloud FULL APP 100GB",
                "duration": "12 tháng",
                "priceDisplay": "599k",
                "priceNumeric": 599000,
                "warranty": "FULL-TIME",
                "notes": "GỬI TÀI KHOẢN+ PASS TÀI KHOẢN",
                "category": "Phần mềm sáng tạo",
                "imageUrl": "https://placehold.co/150x150/E2E8F0/000000?text=Adobe+Full" // Placeholder image
            },
            {
                "id": 5,
                "name": "Adobe Creative FULL APP ( Renew Trial)",
                "duration": "12 tháng",
                "priceDisplay": "380k",
                "priceNumeric": 380000,
                "warranty": "FULL-TIME",
                "notes": "Gửi mỗi mail là được anh em (ƯU TIÊN MUA LOẠI NÀY)",
                "category": "Phần mềm sáng tạo",
                "imageUrl": "https://placehold.co/150x150/E2E8F0/000000?text=Adobe+Trial" // Placeholder image
            }
            // Add more products here if needed
        ];

        // --- Simulated Discount/Referral Codes (Frontend Only) ---
        const discountCodes = {
            "GIAM10": { type: "percentage", value: 0.10 }, // 10% off
            "FIXED50": { type: "fixed", value: 50000 } // 50k VND off
        };
        const referralCodes = {
            "FRIEND1": { message: "Bạn được giới thiệu bởi FRIEND1" },
            "PROMO2023": { message: "Sử dụng mã giới thiệu PROMO2023" }
        };


        // --- DOM Elements ---
        const productListDiv = document.getElementById('product-list');
        // Desktop Filter/Sort Elements
        const searchInputDesktop = document.getElementById('search-input');
        const categoryFilterSelectDesktop = document.getElementById('category-filter');
        const sortSelectDesktop = document.getElementById('sort-select');
        // Mobile Filter/Sort Elements
        const searchInputMobile = document.getElementById('search-input-mobile');
        const categoryFilterSelectMobile = document.getElementById('category-filter-mobile');
        const sortSelectMobile = document.getElementById('sort-select-mobile');

        const cartIcon = document.getElementById('cart-icon');
        const cartCountSpan = document.getElementById('cart-count');
        const cartDropdown = document.getElementById('cart-dropdown');
        const cartItemsDropdownDiv = document.getElementById('cart-items-dropdown');
        const cartTotalDropdownSpan = document.getElementById('cart-total-dropdown');
        // Renamed button in dropdown to go directly to checkout view (step 1)
        const goToCheckoutBtnDropdown = document.getElementById('go-to-checkout-btn-dropdown');


        // View Sections
        const productListView = document.getElementById('product-list-view');
        // Cart View is now integrated into Checkout View as Step 1
        // const cartView = document.getElementById('cart-view');
        const checkoutView = document.getElementById('checkout-view'); // This now contains all checkout steps
        const sidebar = document.getElementById('sidebar');
        const mobileFilterBar = document.getElementById('mobile-filter-bar');

        // Product List View Elements
        const noProductsMessage = document.getElementById('no-products-message');

        // Checkout View Elements (All steps are children of #checkout-view)
        const checkoutSteps = document.querySelectorAll('#checkout-view > div'); // Select all direct children div of checkout-view
        const stepIndicators = document.querySelectorAll('#checkout-view .flex > div'); // Step indicator elements

        // Step 1 Elements (Cart View + Codes)
        const checkoutStep1 = document.getElementById('checkout-step-1'); // The new step 1 div
        const cartItemsListDiv = checkoutStep1.querySelector('#cart-items-list'); // Get elements within step 1
        const cartEmptyMessageDiv = checkoutStep1.querySelector('#cart-empty-message');
        const cartSummaryArea = checkoutStep1.querySelector('#cart-summary-area');
        const cartTotalSpan = checkoutStep1.querySelector('#cart-total');
        const continueShoppingBtn = checkoutStep1.querySelector('#continue-shopping-btn');
        const goShoppingFromCartBtn = checkoutStep1.querySelector('#go-shopping-from-cart');
        const discountCodeInput = checkoutStep1.querySelector('#discount-code');
        const referralCodeInput = checkoutStep1.querySelector('#referral-code');
        const applyCodesBtn = checkoutStep1.querySelector('#apply-codes-btn');
        const discountMessage = checkoutStep1.querySelector('#discount-message');
        const referralMessage = checkoutStep1.querySelector('#referral-message');
        const nextStep2Btn = checkoutStep1.querySelector('#next-step-2-btn'); // Button to move from step 1 to 2


        // Step 2 Elements (Recipient Info)
        const checkoutStep2 = document.getElementById('checkout-step-2'); // The new step 2 div
        const recipientNameInput = checkoutStep2.querySelector('#recipient-name');
        const recipientEmailInput = checkoutStep2.querySelector('#recipient-email');
        const orderNotesInput = checkoutStep2.querySelector('#order-notes');
        const prevStep1Btn = checkoutStep2.querySelector('#prev-step-1-btn'); // Button to move from step 2 to 1
        const nextStep3Btn = checkoutStep2.querySelector('#next-step-3-btn'); // Button to move from step 2 to 3


        // Step 3 Elements (Payment Method Selection)
        const checkoutStep3 = document.getElementById('checkout-step-3'); // The new step 3 div
        const prevStep2Btn = checkoutStep3.querySelector('#prev-step-2-btn'); // Button to move from step 3 to 2
        const completeOrderBtn = checkoutStep3.querySelector('#complete-order-btn'); // Button to move from step 3 to 4


        // Step 4 Elements (Order Confirmation)
        const checkoutStep4 = document.getElementById('checkout-step-4'); // The new step 4 div
        const orderIdSpan = checkoutStep4.querySelector('#order-id');
        const orderIdInInstructionSpan = checkoutStep4.querySelector('#order-id-in-instruction');
        const paymentInstructionsDiv = checkoutStep4.querySelector('#payment-instructions');
        const paymentQrImg = checkoutStep4.querySelector('#payment-qr-img');
        const paymentAccountInfoP = checkoutStep4.querySelector('#payment-account-info');
        const backToHomeBtnCheckout = checkoutStep4.querySelector('#back-to-home-btn-checkout');


        // Global Elements
        const messageBox = document.getElementById('message-box');
        const messageBoxText = document.getElementById('message-box-text');
        const navLinks = document.querySelectorAll('.nav-link');


        // --- State Variables ---
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentStep = 1; // Current step within the checkout process (1 to 4)
        let currentOrder = {}; // To store order details during checkout (simulated)
        let appliedDiscount = 0; // Simulated applied discount amount
        let appliedReferral = null; // Simulated applied referral code


        const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');

        if (mobileNavLinks) {
            mobileNavLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    const viewId = event.currentTarget.dataset.view;
                    if (viewId) {
                        showView(viewId);
                    }
                });
            });
        }


        // --- Helper Functions ---

        // Format price to VND (e.g., 560.000đ)
        function formatPrice(price) {
            if (typeof price !== 'number') {
                const priceStr = String(price).toLowerCase().replace(/\s/g, '');
                if (priceStr.endsWith('k')) {
                    price = parseFloat(priceStr) * 1000;
                } else {
                    price = parseFloat(priceStr);
                }
                if (isNaN(price)) return 'N/A';
            }
            return price.toLocaleString('vi-VN') + 'đ';
        }

        // Calculate total cart amount including simulated discounts
        function calculateCartTotal() {
            let total = cart.reduce((sum, item) => sum + item.priceNumeric * item.quantity, 0);

            // Apply simulated discount
            total -= appliedDiscount;

            // Ensure total is not negative
            return Math.max(0, total);
        }


        // Show a temporary message box
        function showMessage(message, duration = 3000, isError = false) {
            messageBoxText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-blue-500', 'bg-red-500');
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-blue-500');

            messageBox.style.opacity = '1';
            messageBox.style.transition = 'opacity 0.3s ease-in-out';

            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, duration);
        }


        // --- Render Functions ---

        // Render products to the list
        function renderProducts(productsToRender) {
            productListDiv.innerHTML = '';
            if (productsToRender.length === 0) {
                noProductsMessage.classList.remove('hidden');
                return;
            }
            noProductsMessage.classList.add('hidden');

            productsToRender.forEach(product => {
                const productElement = document.createElement('div');
                productElement.classList.add('bg-white', 'rounded-lg', 'shadow-md', 'overflow-hidden', 'transform', 'hover:scale-103', 'transition-transform', 'duration-200', 'ease-in-out', 'flex', 'flex-col');
                productElement.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-2 flex-grow">${product.duration} | Bảo hành: ${product.warranty}</p>
                        <div class="flex items-center justify-between mt-auto">
                            <p class="text-blue-600 text-xl font-bold">${formatPrice(product.priceNumeric)}</p>
                             <button class="add-to-cart-btn bg-blue-600 text-white text-sm py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-sm" data-id="${product.id}">
                                <i class="fas fa-plus mr-1"></i> Thêm
                             </button>
                        </div>
                    </div>
                `;
                productListDiv.appendChild(productElement);
            });
        }

        // Populate category filter options for both desktop and mobile selects
        function populateCategoryFilter() {
            const categories = [...new Set(products.map(p => p.category))];
            const optionsHtml = '<option value="all">Tất cả</option>' + categories.map(category => {
                if (category) {
                    return `<option value="${category}">${category}</option>`;
                }
                return '';
            }).join('');

            if (categoryFilterSelectDesktop) categoryFilterSelectDesktop.innerHTML = optionsHtml;
            if (categoryFilterSelectMobile) categoryFilterSelectMobile.innerHTML = '<option value="all">Danh mục</option>' + optionsHtml;
        }

        // Update cart count icon and totals
        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCountSpan) cartCountSpan.textContent = count;

            const total = calculateCartTotal(); // Use calculated total
            if (cartTotalSpan) cartTotalSpan.textContent = formatPrice(total);
            if (cartTotalDropdownSpan) cartTotalDropdownSpan.textContent = formatPrice(total);

            // Enable/disable checkout button (now next-step-2-btn in step 1) based on cart count
            if (count > 0) {
                if (nextStep2Btn) {
                    nextStep2Btn.disabled = false; // Use nextStep2Btn from step 1
                    nextStep2Btn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                }
                if (cartEmptyMessageDiv) cartEmptyMessageDiv.classList.add('hidden');
                if (cartSummaryArea) cartSummaryArea.classList.remove('hidden');
            } else {
                if (nextStep2Btn) {
                    nextStep2Btn.disabled = true; // Use nextStep2Btn from step 1
                    nextStep2Btn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
                }
                if (cartEmptyMessageDiv) cartEmptyMessageDiv.classList.remove('hidden');
                if (cartSummaryArea) cartSummaryArea.classList.add('hidden');

                // Reset discount/referral if cart becomes empty
                appliedDiscount = 0;
                appliedReferral = null;
                updateDiscountReferralDisplay(); // Clear messages in step 1 if visible
            }
        }

        // Render cart items in the dropdown
        function renderCartDropdown() {
            if (!cartItemsDropdownDiv) return; // Check if element exists

            cartItemsDropdownDiv.innerHTML = '';
            if (cart.length === 0) {
                cartItemsDropdownDiv.textContent = 'Giỏ hàng trống';
                if (cartTotalDropdownSpan) cartTotalDropdownSpan.textContent = '0đ';
                return;
            }
            let total = 0;
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'border-b', 'border-gray-100', 'last:border-b-0');
                itemElement.innerHTML = `
                    <span class="text-sm text-gray-800">${item.name} x ${item.quantity}</span>
                    <span class="text-sm font-semibold text-gray-800">${formatPrice(item.priceNumeric * item.quantity)}</span>
                `;
                cartItemsDropdownDiv.appendChild(itemElement);
                total += item.priceNumeric * item.quantity;
            });
            if (cartTotalDropdownSpan) cartTotalDropdownSpan.textContent = formatPrice(calculateCartTotal()); // Use calculated total
        }

        // Render cart items in the main cart view (Now part of Step 1)
        function renderCartView() {
            if (!cartItemsListDiv) {
                console.error("cartItemsListDiv not found for rendering cart view."); // LOG
                return;
            }

            cartItemsListDiv.innerHTML = '';
            if (cart.length === 0) {
                // Handled by updateCartCount
                if (cartTotalSpan) cartTotalSpan.textContent = '0đ';
                return;
            }

            let total = 0;
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('flex', 'flex-col', 'md:flex-row', 'items-center', 'border-b', 'border-gray-200', 'py-4', 'last:border-b-0');
                itemElement.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md mr-0 md:mr-4 mb-4 md:mb-0 border border-gray-200">
                    <div class="flex-grow text-center md:text-left mb-4 md:mb-0">
                        <h3 class="text-lg font-semibold text-gray-800">${item.name}</h3>
                        <p class="text-gray-600 text-sm">${item.duration} | Bảo hành: ${item.warranty}</p>
                        <p class="text-blue-600 font-bold mt-1">${formatPrice(item.priceNumeric)}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="update-quantity-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-md flex items-center justify-center hover:bg-gray-300 transition-colors duration-200" data-id="${item.id}" data-action="decrease">-</button>
                        <span class="px-3 py-1 border-t border-b border-gray-200 bg-gray-50 rounded-md">${item.quantity}</span>
                        <button class="update-quantity-btn bg-gray-200 text-gray-700 w-8 h-8 rounded-md flex items-center justify-center hover:bg-gray-300 transition-colors duration-200" data-id="${item.id}" data-action="increase">+</button>
                        <button class="remove-from-cart-btn text-red-600 ml-4 hover:text-red-800 transition-colors duration-200 p-2 rounded-full hover:bg-red-100" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                cartItemsListDiv.appendChild(itemElement);
                total += item.priceNumeric * item.quantity;
            });
            if (cartTotalSpan) cartTotalSpan.textContent = formatPrice(calculateCartTotal()); // Use calculated total
        }

        // Render order summary in checkout step 1 (Now part of Step 1's display)
        // This function is now primarily used to update the summary section within Step 1
        function renderOrderSummaryStep1() {
            // The summary is already integrated into renderCartView and updateCartCount
            // This function can be used to specifically update the total area if needed after code application
            updateCartCount(); // This will update the total display in step 1
            updateDiscountReferralDisplay(); // Ensure messages are shown/hidden
        }

        // Update display messages for discount/referral codes
        function updateDiscountReferralDisplay() {
            if (appliedDiscount > 0) {
                if (discountMessage) {
                    discountMessage.textContent = `Đã áp dụng giảm giá: -${formatPrice(appliedDiscount)}`;
                    discountMessage.classList.remove('hidden');
                }
            } else {
                if (discountMessage) discountMessage.classList.add('hidden');
            }

            if (appliedReferral) {
                if (referralMessage) {
                    referralMessage.textContent = `Mã giới thiệu: ${appliedReferral.message}`;
                    referralMessage.classList.remove('hidden');
                }
            } else {
                if (referralMessage) referralMessage.classList.add('hidden');
            }
        }


        // --- Cart Logic ---

        // Add product to cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const existingItemIndex = cart.findIndex(item => item.id === productId);
                if (existingItemIndex > -1) {
                    cart[existingItemIndex].quantity += 1;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                saveCart();
                updateCartCount();
                renderCartDropdown();
                showMessage(`Đã thêm "${product.name}" vào giỏ hàng!`);
            }
        }

        // Remove product from cart
        function removeFromCart(productId) {
            const initialCartLength = cart.length;
            cart = cart.filter(item => item.id !== productId);
            if (cart.length < initialCartLength) {
                saveCart();
                updateCartCount();
                renderCartDropdown();
                // If currently in checkout step 1, re-render the cart view
                if (currentStep === 1 && document.getElementById('checkout-view').classList.contains('active')) {
                    renderCartView();
                }
                // Update summary display if in step 1
                if (currentStep === 1 && document.getElementById('checkout-view').classList.contains('active')) {
                    renderOrderSummaryStep1();
                }
                showMessage("Đã xóa sản phẩm khỏi giỏ hàng.");
            }
        }

        // Update item quantity in cart
        function updateQuantity(productId, action) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                if (action === 'increase') {
                    item.quantity += 1;
                } else if (action === 'decrease') {
                    if (item.quantity > 1) {
                        item.quantity -= 1;
                    } else {
                        removeFromCart(productId);
                        return;
                    }
                }
                saveCart();
                updateCartCount();
                renderCartDropdown();
                // If currently in checkout step 1, re-render the cart view
                if (currentStep === 1 && document.getElementById('checkout-view').classList.contains('active')) {
                    renderCartView();
                }
                // Update summary display if in step 1
                if (currentStep === 1 && document.getElementById('checkout-view').classList.contains('active')) {
                    renderOrderSummaryStep1();
                }
            }
        }

        // Save cart to localStorage
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        // --- View Management ---

        // Show a specific view section (product list or checkout)

        function showView(viewId) {
            // Ẩn tất cả view-section bằng cách xóa class active
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));

            // Ẩn bộ lọc
            if (sidebar) sidebar.classList.add('hidden');
            if (mobileFilterBar) mobileFilterBar.classList.add('hidden');

            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');

                if (viewId === 'product-list-view') {
                    if (window.innerWidth >= 768) {
                        if (sidebar) sidebar.classList.remove('hidden');
                        if (mobileFilterBar) mobileFilterBar.classList.add('hidden');
                    } else {
                        if (sidebar) sidebar.classList.add('hidden');
                        if (mobileFilterBar) mobileFilterBar.classList.remove('hidden');
                    }
                    applyFiltersAndSort();
                } else if (viewId === 'checkout-view') {
                    // Khi chuyển sang thanh toán, reset về bước 1
                    currentStep = 1;
                    showCheckoutStep(currentStep);

                    // Reset mã giảm giá và mã giới thiệu
                    if (discountCodeInput) discountCodeInput.value = '';
                    if (referralCodeInput) referralCodeInput.value = '';
                    appliedDiscount = 0;
                    appliedReferral = null;
                    updateDiscountReferralDisplay();
                }
            } else {
                console.error("Không tìm thấy view:", viewId);
            }

            // Cập nhật trạng thái active cho các nav-link nếu có
            if (navLinks) {
                navLinks.forEach(link => {
                    if (link.dataset.view === viewId) {
                        link.classList.add('font-bold');
                    } else {
                        link.classList.remove('font-bold');
                    }
                });
            }
        }


        // Show a specific checkout step and update step indicator
        function showCheckoutStep(step) {
            if (!checkoutSteps || checkoutSteps.length === 0) {
                console.error("Checkout steps elements not found.");
                return;
            }

            checkoutSteps.forEach(s => s.classList.remove('active'));
            const targetStepElement = document.getElementById(`checkout-step-${step}`);
            if (targetStepElement) {
                targetStepElement.classList.add('active');
            }
            else {
                console.error("Invalid checkout step element not found:", step);
                // Fallback to step 1 or product list view
                showView('product-list-view');
                return;
            }


            // Update step indicator
            if (stepIndicators) {
                stepIndicators.forEach((indicator, index) => {
                    // Index is 0-based, steps are 1-based
                    if (index < step) {
                        indicator.classList.remove('border-gray-300', 'text-gray-600');
                        indicator.classList.add('border-blue-600', 'text-blue-600');
                    } else {
                        indicator.classList.remove('border-blue-600', 'text-blue-600');
                        indicator.classList.add('border-gray-300', 'text-gray-600');
                    }
                });
            }


            // Specific actions for each step
            if (step === 1) {
                renderCartView(); // Ensure cart view is rendered in step 1
                updateCartCount(); // Ensure totals and button state are correct
                renderOrderSummaryStep1(); // Render summary area in step 1
            } else if (step === 2) {
                // No specific render needed, just show the form
            } else if (step === 3) {
                // No specific render needed, just show payment options
            } else if (step === 4) { // Final confirmation step
                const paymentMethodElement = document.querySelector('input[name="payment-method"]:checked');
                const paymentMethod = paymentMethodElement ? paymentMethodElement.value : 'unknown'; // Handle case where none is checked
                currentOrder.paymentMethod = paymentMethod;

                currentOrder.orderId = `ORD-${Date.now()}-${Math.floor(Math.random() * 1000)}`; // Simulate Order ID
                if (orderIdSpan) orderIdSpan.textContent = currentOrder.orderId;
                if (orderIdInInstructionSpan) orderIdInInstructionSpan.textContent = currentOrder.orderId;


                if (paymentMethod === 'qr') {
                    if (paymentQrImg) paymentQrImg.src = `https://placehold.co/200x200/000000/FFFFFF?text=Bank+QR`;
                    if (paymentAccountInfoP) {
                        paymentAccountInfoP.innerHTML = `
                              <strong>Ngân hàng:</strong> Tên Ngân hàng<br>
                              <strong>Số tài khoản:</strong> 1234567890<br>
                              <strong>Chủ tài khoản:</strong> Nguyen Van A
                          `;
                    }
                    if (paymentQrImg) paymentQrImg.classList.remove('hidden');
                } else if (paymentMethod === 'momo') {
                    if (paymentQrImg) paymentQrImg.src = `https://placehold.co/200x200/C21373/FFFFFF?text=Momo+QR`;
                    if (paymentAccountInfoP) {
                        paymentAccountInfoP.innerHTML = `
                              <strong>Ví Momo:</strong> 0912 345 678<br>
                              <strong>Chủ ví:</strong> Nguyen Van A
                          `;
                    }
                    if (paymentQrImg) paymentQrImg.classList.remove('hidden');
                } else {
                    if (paymentQrImg) paymentQrImg.classList.add('hidden');
                    if (paymentAccountInfoP) paymentAccountInfoP.textContent = "Không có thông tin thanh toán.";
                }

                // Simulate clearing cart after "placing" order
                cart = [];
                saveCart();
                updateCartCount();
                renderCartDropdown();
                // Reset discount/referral state after order completion
                appliedDiscount = 0;
                appliedReferral = null;
                updateDiscountReferralDisplay(); // Clear messages
            }
        }


        // --- Filter and Sort Logic ---

        // Apply current filters and sort to products
        function applyFiltersAndSort() {
            let filteredProducts = [...products];

            const isMobile = window.innerWidth < 768;
            const currentSearchInput = isMobile ? searchInputMobile : searchInputDesktop;
            const currentCategorySelect = isMobile ? categoryFilterSelectMobile : categoryFilterSelectDesktop;
            const currentSortSelect = isMobile ? sortSelectMobile : sortSelectDesktop;

            if (!currentSearchInput || !currentCategorySelect || !currentSortSelect) {
                renderProducts(products); // Render all products as fallback
                return;
            }


            const searchTerm = currentSearchInput.value.toLowerCase();
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product =>
                    product.name.toLowerCase().includes(searchTerm)
                );
            }

            const selectedCategory = currentCategorySelect.value;
            if (selectedCategory !== 'all') {
                filteredProducts = filteredProducts.filter(product =>
                    product.category === selectedCategory
                );
            }

            const sortValue = currentSortSelect.value;
            filteredProducts.sort((a, b) => {
                if (sortValue === 'name-asc') {
                    return a.name.localeCompare(b.name);
                } else if (sortValue === 'name-desc') {
                    return b.name.localeCompare(a.name);
                } else if (sortValue === 'price-asc') {
                    return a.priceNumeric - b.priceNumeric;
                } else if (sortValue === 'price-desc') {
                    return b.priceNumeric - a.priceNumeric;
                }
                return 0;
            });

            renderProducts(filteredProducts);
        }

        // --- Event Listeners ---

        // Navigation links (only Product List remains)
        if (navLinks) {
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    const viewId = event.target.dataset.view;
                    if (viewId) {
                        showView(viewId);
                    }
                });
            });
        }


        // Add to Cart button listener (delegation)
        if (productListDiv) {
            productListDiv.addEventListener('click', (event) => {
                if (event.target.classList.contains('add-to-cart-btn')) {
                    const productId = parseInt(event.target.dataset.id);
                    addToCart(productId);
                }
            });
        }


        // Search input listeners (both desktop and mobile)
        if (searchInputDesktop) searchInputDesktop.addEventListener('input', applyFiltersAndSort);
        if (searchInputMobile) searchInputMobile.addEventListener('input', applyFiltersAndSort);

        // Category filter listeners (both desktop and mobile)
        if (categoryFilterSelectDesktop) categoryFilterSelectDesktop.addEventListener('change', applyFiltersAndSort);
        if (categoryFilterSelectMobile) categoryFilterSelectMobile.addEventListener('change', applyFiltersAndSort);

        // Sort select listeners (both desktop and mobile)
        if (sortSelectDesktop) sortSelectDesktop.addEventListener('change', applyFiltersAndSort);
        if (sortSelectMobile) sortSelectMobile.addEventListener('change', applyFiltersAndSort);


        // Cart icon click listener (toggle dropdown)
        if (cartIcon) {
            cartIcon.addEventListener('click', (event) => {
                event.stopPropagation();
                if (cartDropdown) {
                    cartDropdown.classList.toggle('hidden');
                    if (!cartDropdown.classList.contains('hidden')) {
                        setTimeout(() => {
                            cartDropdown.classList.remove('scale-95', 'opacity-0');
                            cartDropdown.classList.add('scale-100', 'opacity-100');
                        }, 10);
                    } else {
                        cartDropdown.classList.remove('scale-100', 'opacity-100');
                        cartDropdown.classList.add('scale-95', 'opacity-0');
                    }
                }
            });
        }


        // Hide dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (cartIcon && cartDropdown && !cartIcon.contains(event.target) && !cartDropdown.contains(event.target)) {
                cartDropdown.classList.add('hidden');
                cartDropdown.classList.remove('scale-100', 'opacity-100');
                cartDropdown.classList.add('scale-95', 'opacity-0');
            }
        });


        // Go to Checkout button listener (in dropdown - now goes to checkout view step 1)
        if (goToCheckoutBtnDropdown) { // Check if element exists
            goToCheckoutBtnDropdown.addEventListener('click', () => {
                showView('checkout-view'); // Go to the checkout view
                if (cartDropdown) {
                    cartDropdown.classList.add('hidden'); // Hide dropdown
                    cartDropdown.classList.remove('scale-100', 'opacity-100');
                    cartDropdown.classList.add('scale-95', 'opacity-0');
                }
            });
        }

        // Remove/Update quantity button listeners (delegation in cart view - now part of Step 1)
        if (cartItemsListDiv) { // Check if element exists
            cartItemsListDiv.addEventListener('click', (event) => {
                const target = event.target;
                const button = target.closest('.remove-from-cart-btn') || target.closest('.update-quantity-btn');

                if (button) {
                    const productId = parseInt(button.dataset.id);
                    if (button.classList.contains('remove-from-cart-btn')) {
                        removeFromCart(productId);
                    } else if (button.classList.contains('update-quantity-btn')) {
                        const action = button.dataset.action;
                        updateQuantity(productId, action);
                    }
                }
            });
        }

        // Go Shopping from Empty Cart button (in Step 1)
        if (goShoppingFromCartBtn) { // Check if element exists
            goShoppingFromCartBtn.addEventListener('click', () => {
                showView('product-list-view');
            });
        }

        // Continue Shopping button (in Step 1)
        if (continueShoppingBtn) { // Check if element exists
            continueShoppingBtn.addEventListener('click', () => {
                showView('product-list-view');
            });
        }


        // --- Checkout Step Navigation ---

        // Step 1: Apply Codes button
        if (applyCodesBtn && discountCodeInput && referralCodeInput && discountMessage && referralMessage) { // Check if elements exist
            applyCodesBtn.addEventListener('click', () => {
                const discountCode = discountCodeInput.value.trim().toUpperCase();
                const referralCode = referralCodeInput.value.trim();

                appliedDiscount = 0; // Reset previous discount
                appliedReferral = null; // Reset previous referral

                // Simulate applying discount code
                if (discountCode && discountCodes[discountCode]) {
                    const discount = discountCodes[discountCode];
                    const subtotal = cart.reduce((sum, item) => sum + item.priceNumeric * item.quantity, 0);
                    if (discount.type === "percentage") {
                        appliedDiscount = subtotal * discount.value;
                    } else if (discount.type === "fixed") {
                        appliedDiscount = discount.value;
                    }
                    showMessage(`Mã giảm giá "${discountCode}" đã được áp dụng!`, 3000);
                } else if (discountCode) {
                    showMessage(`Mã giảm giá "${discountCode}" không hợp lệ.`, 3000, true);
                }

                // Simulate applying referral code
                if (referralCode && referralCodes[referralCode]) {
                    appliedReferral = referralCodes[referralCode];
                    showMessage(`Mã giới thiệu "${referralCode}" đã được áp dụng!`, 3000);
                } else if (referralCode) {
                    showMessage(`Mã giới thiệu "${referralCode}" không hợp lệ.`, 3000, true);
                }

                // Update summary and total display
                renderOrderSummaryStep1(); // Update summary area in step 1
                updateDiscountReferralDisplay(); // Update messages in step 1
                updateCartCount(); // Update total in cart icon/dropdown as well
            });
        }


        // Next Step 2 button (from Step 1 to Step 2)
        if (nextStep2Btn) { // Check if element exists
            nextStep2Btn.addEventListener('click', () => {
                // Check if cart is empty before proceeding
                if (cart.length === 0) {
                    showMessage("Giỏ hàng trống, không thể tiếp tục thanh toán.", 3000, true);
                    return;
                }

                currentStep = 2;
                showCheckoutStep(currentStep);
            });
        }


        // Previous Step 1 button (from Step 2 to Step 1)
        if (prevStep1Btn) { // Check if element exists
            prevStep1Btn.addEventListener('click', () => {
                currentStep = 1;
                showCheckoutStep(currentStep);
            });
        }


        // Next Step 3 button (from Step 2 to Step 3 - Payment Method Selection)
        if (nextStep3Btn && recipientNameInput && recipientEmailInput) { // Check if elements exist
            nextStep3Btn.addEventListener('click', () => {
                // Validation for Step 2 (Recipient Info)
                const recipientName = recipientNameInput.value.trim();
                const recipientEmail = recipientEmailInput.value.trim();
                const orderNotes = orderNotesInput ? orderNotesInput.value.trim() : ''; // Notes are optional, handle if element doesn't exist

                if (!recipientName || !recipientEmail) {
                    showMessage("Vui lòng điền đầy đủ Tên người nhận và Email.", 3000, true);
                    return;
                }
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(recipientEmail)) {
                    showMessage("Định dạng Email không hợp lệ.", 3000, true);
                    return;
                }
                // Phone is not required in this version based on the request

                // Store recipient info temporarily
                currentOrder.recipientInfo = {
                    name: recipientName,
                    email: recipientEmail,
                    notes: orderNotes
                };

                currentStep = 3;
                showCheckoutStep(currentStep);
            });
        }

        // Previous Step 2 button (from Step 3 to Step 2)
        if (prevStep2Btn) { // Check if element exists
            prevStep2Btn.addEventListener('click', () => {
                currentStep = 2;
                showCheckoutStep(currentStep);
            });
        }


        // Complete Order button (from Step 3 to Step 4 - Confirmation)
        if (completeOrderBtn) { // Check if element exists
            completeOrderBtn.addEventListener('click', () => {
                // Get selected payment method
                const paymentMethodElement = document.querySelector('input[name="payment-method"]:checked');
                if (!paymentMethodElement) {
                    showMessage("Vui lòng chọn phương thức thanh toán.", 3000, true);
                    return;
                }
                const paymentMethod = paymentMethodElement.value;
                currentOrder.paymentMethod = paymentMethod;


                // Collect all order details for simulation
                currentOrder.items = cart;
                currentOrder.subtotal = cart.reduce((sum, item) => sum + item.priceNumeric * item.quantity, 0);
                currentOrder.discountAmount = appliedDiscount;
                currentOrder.referralCode = appliedReferral ? (referralCodeInput ? referralCodeInput.value.trim() : null) : null; // Store the code string, handle if input doesn't exist
                currentOrder.totalAmount = calculateCartTotal();
                currentOrder.orderTimestamp = new Date().toISOString(); // ISO format timestamp

                // Simulate placing order by going to step 4
                // No actual backend call happens here
                console.log("Simulated Order Placed:", currentOrder); // LOG

                currentStep = 4; // Move to the final confirmation step
                showCheckoutStep(currentStep);

                // Cart clearing and order ID generation moved into showCheckoutStep(4)
                // Discount/Referral state reset moved into showCheckoutStep(4)
            });
        }


        // Back to Home button (in step 4)
        if (backToHomeBtnCheckout) { // Check if element exists
            backToHomeBtnCheckout.addEventListener('click', () => {
                // Reset checkout state and go back to product list
                currentOrder = {};
                // Clear input fields in step 2 for next order
                if (recipientNameInput) recipientNameInput.value = '';
                if (recipientEmailInput) recipientEmailInput.value = '';
                if (orderNotesInput) orderNotesInput.value = '';

                showView('product-list-view');
            });
        }

        // --- Handle Window Resize ---
        window.addEventListener('resize', () => {
            if (document.getElementById('product-list-view').classList.contains('active')) {
                if (window.innerWidth >= 768) {
                    if (sidebar) sidebar.classList.remove('hidden');
                    if (mobileFilterBar) mobileFilterBar.classList.add('hidden');
                } else {
                    if (sidebar) sidebar.classList.add('hidden');
                    if (mobileFilterBar) mobileFilterBar.classList.remove('hidden');
                }
            }
        });


        // --- Initialization ---
        window.onload = function () {
            // Products are hardcoded
            populateCategoryFilter();
            applyFiltersAndSort(); // Initial render of products

            // Initialize cart display
            updateCartCount();
            renderCartDropdown();

            // Ensure product list view is active initially and filter bars are set correctly
            showView('product-list-view');
        };


        const checkOrderBtn = document.getElementById('check-order-btn');
        const orderCodeInput = document.getElementById('order-code-input');
        const orderResultDiv = document.getElementById('order-result');

        if (checkOrderBtn && orderCodeInput && orderResultDiv) {
            checkOrderBtn.addEventListener('click', async () => {
                const code = orderCodeInput.value.trim();
                orderResultDiv.classList.add('hidden');

                if (!code) {
                    showMessage("Vui lòng nhập mã đơn hàng để kiểm tra.", 3000, true);
                    return;
                }

                try {
                    const res = await fetch('./Order.json');
                    if (!res.ok) throw new Error("Không thể tải dữ liệu đơn hàng");

                    const orders = await res.json();
                    const found = orders.find(order => order.orderId === code);

                    if (found) {
                        orderResultDiv.innerHTML = `
                    <p><strong>Mã đơn:</strong> ${found.orderId}</p>
                    <p><strong>Tên người nhận:</strong> ${found.name}</p>
                    <p><strong>Email:</strong> ${found.email}</p>
                    <p><strong>Tổng tiền:</strong> ${formatPrice(found.total)}</p>
                    <p><strong>Trạng thái:</strong> ${found.status}</p>
                `;
                    } else {
                        orderResultDiv.innerHTML = `<p class="text-red-600 font-semibold">Không tìm thấy đơn hàng với mã <strong>${code}</strong>.</p>`;
                    }

                    orderResultDiv.classList.remove('hidden');
                } catch (err) {
                    console.error(err);
                    showMessage("Lỗi khi kiểm tra đơn hàng.", 3000, true);
                }
            });
        }

    </script>

</body>

</html>